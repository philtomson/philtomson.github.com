
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Comparing a Machine Learning Algorithm Implemented in F# and OCaml - My Little Garden of Code</title>
  <meta name="author" content="Phil Tomson">

  
  <meta name="description" content="(UPDATE: please see the next post: Stop the Presses: OCaml wins in terms of speed in which it is shown that there were some serious flaws in my OCaml &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://philtomson.github.io/blog/2014/05/29/comparing-a-machine-learning-algorithm-implemented-in-f-number-and-ocaml/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="My Little Garden of Code" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Little Garden of Code</a></h1>
  
    <h2>bloggings about codings</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="philtomson.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Comparing a Machine Learning Algorithm Implemented in F# and OCaml</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-29T18:30:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:30 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://philtomson.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>(UPDATE: please see the <a href="http://philtomson.github.io/blog/2014/05/30/stop-the-presses-ocaml-wins/">next post: Stop the Presses: OCaml wins in terms of speed</a> in which it is shown that there were some serious flaws in my OCaml implementation below. I&rsquo;ll keep this post around for reference.)</p>

<p>I&rsquo;ve been dabbling with OCaml for the last several years and so when I saw a recent Meetup notice about an F# machine learning code dojo being led by <a href="https://github.com/mathias-brandewinder">Mathias Brandewinder</a> within walking distance of my house I thought I&rsquo;d check it out. I&rsquo;m one of those Linux guys who tends to eschew IDEs, prefers to use vim, and considers .NET to be some very foreign territory. F# is based on OCaml, so I figured I&rsquo;d have a bit of a headstart in the language area even if I haven&rsquo;t done any .NET development.</p>

<p>Also, I was curious as I had been hearing rumors on twitter that F# programs were running on Mono faster than the equivalent OCaml versions.  I was also taking Andrew Ng&rsquo;s Coursera Machine Learning course so the timing seemed good. So I loaded up <a href="http://www.mono-project.com/Main_Page">mono</a>, <a href="http://monodevelop.com/">monodevelop</a> and F#. As it turns out none of it worked on the day of the dojo, so I looked on with someone with a Windows laptop and Visual Studio.</p>

<p>The code dojo itself was a great way of learning F#. Check out Mathias' <a href="https://github.com/c4fsharp/Dojo-Digits-Recognizer">Digits Recognizer code Dojo code and instructions</a> which in turn was based on <a href="http://www.kaggle.com/c/digit-recognizer">a Kaggle Machine Learning challenge</a>.
The task was to implement a <a href="http://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm">k-NN</a> (K Nearest Neighbor; in this case K=1) algorithm for recognizing handwritten digits from a dataset that was provided: A training set of 5000 labeled examples and a validation set of 500 labeled examples. Each digit example is a set of 28X28 grayscale pixels (784 integer values from 0 to 255).
We wrote a classifier that reads in the training set and then compares each of the 500 validation samples against those 5000 training exmples and returns the label associated with the closest match (the vector with the shortest distance from a training example). k-NN is one of the simplest machine learning algorithms, even so, we were able to get a 94.4% accuracy rate.</p>

<p>After the Dojo, I spent some time getting Monodevelop and F# running on my Ubuntu 12.04 laptop. Turns out I needed to get Monodevelop 4.0 (built from source) and F# 3.0 (initially tried F# 3.1, but Monodevelop 4.0 wasn&rsquo;t happy with that version). Then I set about reimplementing the algorithm in F# and after I got that working I reimplemented the same algorithm in OCaml.</p>

<p>Here&rsquo;s my F# implementation:</p>

<figure class='code'><figcaption><span>[ ] [title: ClassifyDigits.fs] </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">module</span> <span class="nn">classifyDigits.Main</span>
</span><span class='line'>
</span><span class='line'><span class="k">open</span> <span class="nn">System</span>
</span><span class='line'><span class="k">open</span> <span class="nn">System.IO</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="nc">LabelPixels</span> <span class="o">=</span> <span class="o">{</span> <span class="n">Label</span><span class="o">:</span> <span class="n">int</span><span class="o">;</span> <span class="n">Pixels</span><span class="o">:</span> <span class="n">int</span><span class="bp">[]</span> <span class="o">}</span>
</span><span class='line'><span class="k">let</span> <span class="nv">slurp_file</span> <span class="n">file</span> <span class="o">=</span>
</span><span class='line'>   <span class="nn">File</span><span class="p">.</span><span class="n">ReadAllLines</span><span class="o">(</span><span class="n">file</span><span class="o">).[</span><span class="mi">1</span><span class="o">..]</span>
</span><span class='line'>   <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">Split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">))</span>
</span><span class='line'>   <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">numline</span> <span class="o">-&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Convert</span><span class="p">.</span><span class="n">ToInt32</span><span class="o">(</span><span class="n">x</span><span class="o">))</span> <span class="n">numline</span><span class="o">)</span>
</span><span class='line'>   <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">Label</span><span class="o">=</span> <span class="n">line</span><span class="o">.[</span><span class="mi">0</span><span class="o">];</span> <span class="n">Pixels</span><span class="o">=</span><span class="n">line</span><span class="o">.[</span><span class="mi">1</span><span class="o">..]</span> <span class="o">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//load the trainingsample  </span>
</span><span class='line'><span class="k">let</span> <span class="nv">trainingset</span> <span class="o">=</span> <span class="n">slurp_file</span><span class="o">(</span><span class="s">&quot;/home/phil/devel/f_sharp/Dojo-Digits-Recognizer/Dojo/trainingsample.csv&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//  COMPUTING DISTANCES</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// We need to compute the distance between images</span>
</span><span class='line'><span class="c1">// Math reminder: the euclidean distance is</span>
</span><span class='line'><span class="c1">// distance [ x1; y1; z1 ] [ x2; y2; z2 ] = </span>
</span><span class='line'><span class="c1">// sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2) + (z1-z2)*(z1-z2))</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="nv">distance</span> <span class="o">(</span><span class="n">p1</span><span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="o">(</span><span class="n">p2</span><span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="nn">Math</span><span class="p">.</span><span class="n">Sqrt</span> <span class="o">(</span><span class="kt">float</span><span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">sum</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span> <span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">pown</span> <span class="o">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">)</span> <span class="mi">2</span><span class="o">))</span> <span class="n">p1</span> <span class="n">p2</span><span class="o">)</span> <span class="o">))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//  WRITING THE CLASSIFIER FUNCTION</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// We are now ready to write a classifier function!</span>
</span><span class='line'><span class="c1">// The classifier should take a set of pixels</span>
</span><span class='line'><span class="c1">// (an array of ints) as an input, search for the</span>
</span><span class='line'><span class="c1">// closest example in our sample, and predict</span>
</span><span class='line'><span class="c1">// the value of that closest element.</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="nv">classify</span> <span class="o">(</span><span class="n">pixels</span><span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="n">fst</span> <span class="o">(</span><span class="n">trainingset</span> <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">Label</span><span class="o">,</span> <span class="o">(</span><span class="n">distance</span> <span class="n">pixels</span> <span class="n">x</span><span class="o">.</span><span class="n">Pixels</span> <span class="o">)</span> <span class="o">))</span>
</span><span class='line'>                   <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">minBy</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="n">x</span> <span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// EVALUATING THE MODEL AGAINST VALIDATION DATA</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Now that we have a classifier, we need to check</span>
</span><span class='line'><span class="c1">// how good it is. </span>
</span><span class='line'><span class="c1">// This is where the 2nd file, validationsample.csv,</span>
</span><span class='line'><span class="c1">// comes in handy. </span>
</span><span class='line'><span class="c1">// For each Example in the 2nd file,</span>
</span><span class='line'><span class="c1">// we know what the true Label is, so we can compare</span>
</span><span class='line'><span class="c1">// that value with what the classifier says.</span>
</span><span class='line'><span class="c1">// You could now check for each 500 example in that file</span>
</span><span class='line'><span class="c1">// whether your classifier returns the correct answer,</span>
</span><span class='line'><span class="c1">// and compute the % correctly predicted.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="nv">_</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="o">(</span><span class="s">&quot;start...&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="nv">validationsample</span> <span class="o">=</span> <span class="n">slurp_file</span><span class="o">(</span><span class="s">&quot;/home/phil/devel/f_sharp/Dojo-Digits-Recognizer/Dojo/validationsample.csv&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">let</span> <span class="nv">num_correct</span> <span class="o">=</span> <span class="o">(</span><span class="n">validationsample</span> <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">classify</span> <span class="n">p</span><span class="o">.</span><span class="n">Pixels</span> <span class="o">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Label</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>                                        <span class="o">|&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sum</span><span class="o">)</span>
</span><span class='line'>    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s">&quot;Percentage correct:%f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">((</span><span class="kt">float</span><span class="o">(</span><span class="n">num_correct</span><span class="o">)/</span> <span class="o">(</span><span class="kt">float</span><span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">validationsample</span><span class="o">)))*</span><span class="mi">100</span><span class="o">.</span><span class="mi">0</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Timing when running this on my Dell XPS 13 (i7 Haswell, 8GB RAM):</p>

<pre><code>real        0m22.180s
user        0m22.253s
sys         0m0.116s
</code></pre>

<p>And the OCaml implementation:</p>

<figure class='code'><figcaption><span>[ ] [title: classifyDigits.ml] </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="c">(* OCaml version</span>
</span><span class='line'><span class="c">   compile with:</span>
</span><span class='line'><span class="c">    ocamlopt str.cmxa -o classifyDigits classifyDigits.ml </span>
</span><span class='line'><span class="c">*)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">read_lines</span> <span class="n">name</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">name</span> <span class="k">in</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">try_read</span> <span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">ic</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
</span><span class='line'>  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">match</span> <span class="n">try_read</span> <span class="bp">()</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Some</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="o">(</span><span class="n">s</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">ic</span><span class="o">;</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">acc</span> <span class="k">in</span>
</span><span class='line'>  <span class="n">loop</span> <span class="bp">[]</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="n">labelPixels</span> <span class="o">=</span> <span class="o">{</span> <span class="n">label</span><span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">pixels</span><span class="o">:</span> <span class="kt">int</span> <span class="kt">list</span> <span class="o">}</span>
</span><span class='line'><span class="k">let</span> <span class="n">slurp_file</span> <span class="n">file</span> <span class="o">=</span>
</span><span class='line'>   <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="n">read_lines</span> <span class="n">file</span><span class="o">)</span>
</span><span class='line'>   <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;,&quot;</span><span class="o">)</span> <span class="n">line</span> <span class="o">)</span>
</span><span class='line'>   <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">numline</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">int_of_string</span> <span class="n">x</span><span class="o">)</span> <span class="n">numline</span><span class="o">)</span>
</span><span class='line'>   <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="n">label</span><span class="o">=</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">line</span><span class="o">);</span> <span class="n">pixels</span><span class="o">=(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="n">line</span><span class="o">)</span> <span class="o">})</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">trainingset</span> <span class="o">=</span> <span class="n">slurp_file</span><span class="o">(</span><span class="s2">&quot;./trainingsample.csv&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">(* </span>
</span><span class='line'><span class="c">// COMPUTING DISTANCES</span>
</span><span class='line'><span class="c"> </span>
</span><span class='line'><span class="c">// We need to compute the distance between images</span>
</span><span class='line'><span class="c">// Math reminder: the euclidean distance is</span>
</span><span class='line'><span class="c">// distance [ x1; y1; z1 ] [ x2; y2; z2 ] = </span>
</span><span class='line'><span class="c">// sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2) + (z1-z2)*(z1-z2))</span>
</span><span class='line'><span class="c">*)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">list_sum</span> <span class="n">lst</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">acc</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">+.</span><span class="n">acc</span><span class="o">)</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="n">lst</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">distance</span> <span class="o">(</span><span class="n">p1</span><span class="o">:</span> <span class="kt">int</span> <span class="kt">list</span><span class="o">)</span> <span class="o">(</span><span class="n">p2</span><span class="o">:</span> <span class="kt">int</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="n">sqrt</span> <span class="o">(</span><span class="n">list_sum</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span> <span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">float_of_int</span><span class="o">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="o">)**</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">))</span> <span class="n">p1</span> <span class="n">p2</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">(* </span>
</span><span class='line'><span class="c">// WRITING THE CLASSIFIER FUNCTION</span>
</span><span class='line'><span class="c"> </span>
</span><span class='line'><span class="c">// We are now ready to write a classifier function!</span>
</span><span class='line'><span class="c">// The classifier should take a set of pixels</span>
</span><span class='line'><span class="c">// (an array of ints) as an input, search for the</span>
</span><span class='line'><span class="c">// closest example in our sample, and predict</span>
</span><span class='line'><span class="c">// the value of that closest element.</span>
</span><span class='line'><span class="c">*)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">minBy</span> <span class="n">f</span> <span class="n">lst</span>  <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">smallest</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">lst</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">f</span> <span class="o">!</span><span class="n">smallest</span><span class="o">)</span> <span class="k">then</span> <span class="n">smallest</span> <span class="o">:=</span> <span class="n">x</span>
</span><span class='line'>                          <span class="o">)</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="n">lst</span><span class="o">)</span> <span class="o">;</span>
</span><span class='line'>  <span class="o">!</span><span class="n">smallest</span> <span class="o">;;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">classify</span> <span class="o">(</span><span class="n">pixels</span><span class="o">:</span> <span class="kt">int</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="n">fst</span> <span class="o">((</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span> <span class="n">labelPixels</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">label</span><span class="o">,</span> <span class="o">(</span><span class="n">distance</span> <span class="n">pixels</span> <span class="n">x</span><span class="o">.</span><span class="n">pixels</span><span class="o">)</span> <span class="o">))</span> <span class="n">trainingset</span><span class="o">)</span>
</span><span class='line'>       <span class="o">|&gt;</span> <span class="n">minBy</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span>  <span class="o">-&gt;</span> <span class="n">snd</span> <span class="n">x</span><span class="o">)</span>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">(*</span>
</span><span class='line'><span class="c">// EVALUATING THE MODEL AGAINST VALIDATION DATA</span>
</span><span class='line'><span class="c"> </span>
</span><span class='line'><span class="c">// Now that we have a classifier, we need to check</span>
</span><span class='line'><span class="c">// how good it is. </span>
</span><span class='line'><span class="c">// This is where the 2nd file, validationsample.csv,</span>
</span><span class='line'><span class="c">// comes in handy. </span>
</span><span class='line'><span class="c">// For each Example in the 2nd file,</span>
</span><span class='line'><span class="c">// we know what the true Label is, so we can compare</span>
</span><span class='line'><span class="c">// that value with what the classifier says.</span>
</span><span class='line'><span class="c">// You could now check for each 500 example in that file</span>
</span><span class='line'><span class="c">// whether your classifier returns the correct answer,</span>
</span><span class='line'><span class="c">// and compute the % correctly predicted.</span>
</span><span class='line'><span class="c">*)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">validationsample</span> <span class="o">=</span> <span class="n">slurp_file</span><span class="o">(</span><span class="s2">&quot;./validationsample.csv&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">num_correct</span> <span class="o">=</span> <span class="o">(</span><span class="n">validationsample</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">classify</span> <span class="n">p</span><span class="o">.</span><span class="n">pixels</span> <span class="o">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">label</span> <span class="k">then</span> <span class="mi">1</span><span class="o">.</span> <span class="k">else</span> <span class="mi">0</span><span class="o">.)</span> <span class="o">|&gt;</span> <span class="n">list_sum</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Percentage correct:%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(((</span><span class="n">num_correct</span><span class="o">)/.</span> <span class="o">(</span><span class="n">float_of_int</span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">validationsample</span><span class="o">)))*.</span><span class="mi">100</span><span class="o">.</span><span class="mi">0</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code is very similar. The OCaml version is a bit longer because I needed to implement some functions that are built into the F# library, specifically, <em>minBy</em> (<em>Array.minBy</em> is built in to thd F# standard lib), <em>list_sum</em> (<em>Array.sum</em> is the F# builtin function) and <em>read_lines</em> (<em>File.ReadAllLines</em> is the F# builtin). One difference that could possibly effect performance: The F# version reads the data into <em>Array</em>s whereas the OCaml version reads the data into <em>List</em>s. The OCaml version was just easier to read into a <em>List</em> and OCaml&rsquo;s <em>List</em> module has a <em>map2</em> function whereas OCaml&rsquo;s <em>Array</em> module does not (F# apparently has a <em>map2</em> for both <em>Array</em> and <em>List</em>).</p>

<p>(EDIT: But as it turns out, using a List here instead of an Array is probably responsible for about &frac12; of the performance difference between the F# and the OCaml version. See <a href="(http://philtomson.github.io/blog/2014/05/30/stop-the-presses-ocaml-wins/">the update</a> )</p>

<p>I was surprised how much less performant the OCaml version was:</p>

<pre><code>real    0m47.311s
user    0m46.881s
sys     0m0.135s
</code></pre>

<p>The F# implementation was slightly more than twice as fast o_O.</p>

<p>Next, I recalled from the dojo that it&rsquo;s very easy to parallelize the maps in F#; instead of <em>Array.map</em> you use <em>Array.parallel.map</em>. So after a couple of edits to add parallel maps, I rebuilt and ran with the following time:</p>

<pre><code>real    0m16.400s
user    0m47.135s
sys     0m0.240s
</code></pre>

<p>So after that very simple change the F# version was very nearly 3X faster than the OCaml version. And in <em>top</em> I could see that the CPU usage was up to 360% as it ran.</p>

<p>Ah, but what about OCaml&rsquo;s <a href="https://github.com/rdicosmo/parmap">Parmap</a>?
I modified my OCaml version to use Parmap&hellip; but it took a lot longer to get it working than parallelizing the F# version. Probably about 30 minutes by the time I got it figured out (including figuring out how to compile it).</p>

<p>Here&rsquo;s the OCaml version of the <em>classify</em> function and <em>num_correct</em> that uses Parmap:</p>

<figure class='code'><figcaption><span>[ ] [title: classifyDigitsPar.ml] </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ocaml'><span class='line'><span class="k">let</span> <span class="n">classify</span> <span class="o">(</span><span class="n">pixels</span><span class="o">:</span> <span class="kt">int</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">label_dist</span> <span class="o">=</span> <span class="nn">Parmap</span><span class="p">.</span><span class="n">parmap</span> <span class="o">~</span><span class="n">chunksize</span><span class="o">:</span><span class="mi">50</span> <span class="o">~</span><span class="n">ncores</span><span class="o">:</span><span class="mi">4</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">label</span><span class="o">,</span> <span class="o">(</span><span class="n">distance</span> <span class="n">pixels</span> <span class="n">x</span><span class="o">.</span><span class="n">pixels</span><span class="o">)</span> <span class="o">))</span> <span class="o">(</span><span class="nn">Parmap</span><span class="p">.</span><span class="nc">L</span> <span class="n">trainingset</span><span class="o">)</span> <span class="k">in</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">min</span> <span class="o">=</span> <span class="n">minBy</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="o">(</span><span class="n">snd</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">snd</span> <span class="n">y</span><span class="o">))</span> <span class="n">label_dist</span> <span class="k">in</span>
</span><span class='line'>  <span class="n">fst</span> <span class="n">min</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">num_correct</span> <span class="o">=</span>
</span><span class='line'>  <span class="o">(</span><span class="nn">Parmap</span><span class="p">.</span><span class="nc">L</span> <span class="n">validationsample</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Parmap</span><span class="p">.</span><span class="n">parmap</span> <span class="o">~</span><span class="n">ncores</span><span class="o">:</span><span class="mi">4</span> <span class="o">(</span><span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">classify</span> <span class="n">p</span><span class="o">.</span><span class="n">pixels</span> <span class="o">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">label</span> <span class="k">then</span> <span class="mi">1</span><span class="o">.</span> <span class="k">else</span> <span class="mi">0</span><span class="o">.)</span> <span class="o">|&gt;</span> <span class="n">list_sum</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that you have to tell it how many cores you have.</p>

<p>After I got it to compile I ran it with much anticipation&hellip;</p>

<pre><code>real    1m43.140s
user    5m38.809s
sys     0m42.811s
</code></pre>

<p>&hellip; over twice as slow as the original OCaml implementation.
I noticed in <em>top</em> that this version launched 4 different <em>classifyDigitPar</em> processes so I&rsquo;m guessing that it uses sockets to communicate between the processes. For this particular problem that doesn&rsquo;t appear to be effective. Perhaps it would be for a longer running example, but I&rsquo;m not sure. F# certainly wins in the parallelization department.</p>

<h3>Observations</h3>

<p>Other than performance (where F# on Mono seems to win handily) I noticed the following:</p>

<ol>
<li>The Array slicing syntax in F# is quite nice.</li>
<li>F#&rsquo;s standard library is just more comprehensive. I could have probably used Janestreet&rsquo;s <em>Core</em> library for OCaml which is quite comprehensive, but I wanted to stick with the standard library for both.</li>
<li>Monodevelop has a <em>vi</em> editing mode. It&rsquo;s kind of ok. But it&rsquo;s missing a lot of keybindings that you&rsquo;d have in native vi.</li>
<li>I have no idea what F#&rsquo;s (or Monodevelop&rsquo;s) equavilent to <em>opam</em> is. I&rsquo;m guessing OCaml wins in the package management department.</li>
<li>F#&rsquo;s polymorphic math operators were nice (no need for <em>+.</em>, etc.).</li>
</ol>


<p>You can find the code above in <a href="https://github.com/philtomson/ClassifyDigits">my github</a></p>

<h3>Next Time</h3>

<p>I want to implement the algorithm in <a href="http://julialang.org/">Julia</a>. I&rsquo;m going to guess that Julia&rsquo;s vectorization support means that it will beat both OCaml and F#.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Phil Tomson</span></span>

      




<time class='entry-date' datetime='2014-05-29T18:30:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:30 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/f-number/'>f#</a>, <a class='category' href='/blog/categories/ocaml/'>ocaml</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/05/14/drawing-happy-little-trees-tree-meditation-number-2/" title="Previous Post: Drawing Happy Little Trees: Tree Meditation #2">&laquo; Drawing Happy Little Trees: Tree Meditation #2</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/05/30/stop-the-presses-ocaml-wins/" title="Next Post: Stop the presses: OCaml wins in terms of speed">Stop the presses: OCaml wins in terms of speed &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/02/02/funemployment/">FUNemployment</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/09/10/some-notes-on-building-and-running-mirage-unikernels-on-cubieboard2/">Some Notes on Building and Running Mirage Unikernels on Cubieboard2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/09/core-dot-async-example/">Cooperative Concurrency in OCaml: A Core.Std.Async Example</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/30/stop-the-presses-ocaml-wins/">Stop the Presses: OCaml Wins in Terms of Speed</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/29/comparing-a-machine-learning-algorithm-implemented-in-f-number-and-ocaml/">Comparing a Machine Learning Algorithm Implemented in F# and OCaml</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/philtomson">@philtomson</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'philtomson',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Phil Tomson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mylittlegardenofcode';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://philtomson.github.io/blog/2014/05/29/comparing-a-machine-learning-algorithm-implemented-in-f-number-and-ocaml/';
        var disqus_url = 'http://philtomson.github.io/blog/2014/05/29/comparing-a-machine-learning-algorithm-implemented-in-f-number-and-ocaml/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
